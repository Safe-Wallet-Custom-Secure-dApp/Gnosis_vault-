import { Octokit } from "@octokit/rest";
import * as fs from "fs";
import * as path from "path";

// ENV VARS required
const GITHUB_TOKEN = process.env.GITHUB_TOKEN!;
const ORG = "Safe-Wallet-Custom-Secure-dApp";

const octokit = new Octokit({ auth: GITHUB_TOKEN });

const rulesetFiles = [
  "main-protection.json",
  "sensitive-files.json",
  "tag-protection.json",
  "demo-repo-light.json"
];

const RULESETS_DIR = path.join(__dirname, "../rulesets");

async function applyRulesets() {
  for (const file of rulesetFiles) {
    const filePath = path.join(RULESETS_DIR, file);
    const ruleset = JSON.parse(fs.readFileSync(filePath, "utf-8"));

    try {
      const res = await octokit.request("POST /orgs/{org}/rulesets", {
        org: ORG,
        name: ruleset.name,
        target: ruleset.target,
        enforcement: ruleset.enforcement,
        conditions: {
          ref_name: {
            include: ruleset.includes
          }
        },
        rules: ruleset.rules,
        bypass_actors: [],
        applies_to: ruleset.repositories || undefined
      });

      console.log(`✅ Applied ruleset: ${ruleset.name}`);
    } catch (err: any) {
      console.error(`❌ Failed to apply ${ruleset.name}:`, err.message);
    }
  }
}

applyRulesets();
